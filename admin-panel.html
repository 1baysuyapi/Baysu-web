<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yönetim Paneli - Ürün Yönetimi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Değişkenleri */
        :root {
            --primary-color: #004797;
            --secondary-color: #FF6B6B;
            --background-color: #F0F2F5;
            --card-background: #FFFFFF;
            --text-color: #333333;
            --light-text-color: #666666;
            --border-color: #E0E0E0;
            --border-radius: 8px;
            --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
        }

        /* Sol Menü (Sidebar) */
        .sidebar {
            width: 250px;
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            box-shadow: var(--box-shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .sidebar-logo {
            width: 150px;
            margin-bottom: 30px;
        }

        .sidebar-nav {
            width: 100%;
        }

        .sidebar-nav a {
            display: block;
            color: white;
            text-decoration: none;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: var(--border-radius);
            transition: background-color 0.3s;
        }

        .sidebar-nav a:hover,
        .sidebar-nav a.active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Ana İçerik Alanı */
        .content {
            flex-grow: 1;
            padding: 40px;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h1 {
            margin: 0;
            font-size: 2rem;
            color: var(--primary-color);
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .add-product-button,
        .logout-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
        }

        .add-product-button {
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.3s;
        }

        .add-product-button:hover {
            background-color: #003366;
        }

        .logout-button {
            background-color: var(--secondary-color);
            color: white;
            transition: background-color 0.3s;
        }

        .logout-button:hover {
            background-color: #d85757;
        }
        
        .card {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
        }

        .card h2 {
            margin-top: 0;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            font-size: 1.2rem;
        }

        .product-table {
            width: 100%;
            border-collapse: collapse;
        }
        .product-table img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
        }

        .product-table th, .product-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
        }

        .product-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .product-table .actions button {
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 5px;
            transition: background-color 0.3s;
        }
        
        .product-table .actions button.edit {
            background-color: #3498db;
        }
        .product-table .actions button.edit:hover {
            background-color: #2980b9;
        }
        
        .product-table .actions button.delete {
            background-color: var(--secondary-color);
        }
        .product-table .actions button.delete:hover {
            background-color: #d85757;
        }

        .product-variations {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .product-variations li {
            margin-bottom: 5px;
        }

        /* Modal Stilleri */
        .modal {
            display: none; /* Varsayılan olarak gizli */
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            width: 600px; /* Modal genişliğini artırdım */
            max-width: 90%;
            box-shadow: var(--box-shadow);
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--text-color);
            text-decoration: none;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .variation-list {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }

        .variation-item {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .variation-item input {
            flex: 1;
        }

        .remove-variation-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .add-variation-btn {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        #image-preview {
            width: 100px;
            height: 100px;
            margin-top: 10px;
            object-fit: cover;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            display: none; /* Varsayılan olarak gizli */
        }

        .modal-buttons {
            text-align: right;
        }

        .modal-buttons button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        .modal-buttons .save-btn {
            background-color: var(--primary-color);
            color: white;
        }
        .modal-buttons .cancel-btn {
            background-color: var(--light-text-color);
            color: white;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <img src="WhatsApp Image 2025-07-25 at 23.57.21 (1)-Photoroom.png" alt="BAYSU LOGO" class="sidebar-logo">
        <nav class="sidebar-nav">
            <a href="#" class="active"><i class="fas fa-box"></i> Ürünler</a>
            <a href="#"><i class="fas fa-chart-line"></i> Siparişler</a>
            <a href="#"><i class="fas fa-users"></i> Kullanıcılar</a>
            <a href="#"><i class="fas fa-cogs"></i> Ayarlar</a>
        </nav>
    </aside>

    <main class="content">
        <header class="header">
            <h1>Ürün Yönetimi</h1>
            <div class="header-actions">
                <button id="addProductBtn" class="add-product-button"><i class="fas fa-plus"></i> Yeni Ürün Ekle</button>
                <a href="login.html" class="logout-button">Çıkış Yap</a>
            </div>
        </header>

        <div class="card">
            <h2>Ürün Listesi</h2>
            <table class="product-table">
                <thead>
                    <tr>
                        <th></th> <!-- Resim için boş başlık -->
                        <th>Ürün Adı</th>
                        <th>Kategori</th>
                        <th>Fiyatlar (Ölçü - Fiyat)</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody id="product-list-body">
                    <!-- Ürünler buraya JavaScript ile veritabanından çekilerek eklenecek -->
                </tbody>
            </table>
        </div>
    </main>

    <!-- Ürün Ekleme/Düzenleme Modalı -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="modalTitle">Yeni Ürün Ekle</h2>
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="form-group">
                    <label for="productName">Ürün Adı</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label for="productCategory">Kategori</label>
                    <input type="text" id="productCategory" required>
                </div>
                <div class="form-group">
                    <label for="productImageFile">Ürün Fotoğrafı Seç</label>
                    <input type="file" id="productImageFile" accept="image/*">
                    <img id="image-preview" src="#" alt="Ürün Fotoğrafı Önizleme">
                </div>

                <h3>Ölçüler ve Fiyatlar</h3>
                <ul id="variations-list" class="variation-list">
                    <!-- Dinamik olarak eklenecek ölçü ve fiyat alanları -->
                </ul>
                <button type="button" id="addVariationBtn" class="add-variation-btn"><i class="fas fa-plus"></i> Ölçü ve Fiyat Ekle</button>

                <div class="modal-buttons">
                    <button type="submit" class="save-btn">Kaydet</button>
                    <button type="button" class="cancel-btn">İptal</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Yükleme Göstergesi -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
    </div>


    <script type="module">
        // Firebase SDK'larını içe aktarın
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase ve Canvas değişkenlerini tanımlayın
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let db, auth, userId;

        // HTML elementlerini alın
        const productListBody = document.getElementById('product-list-body');
        const productModal = document.getElementById('productModal');
        const productForm = document.getElementById('productForm');
        const modalTitle = document.getElementById('modalTitle');
        const productIdInput = document.getElementById('productId');
        const productNameInput = document.getElementById('productName');
        const productCategoryInput = document.getElementById('productCategory');
        const productImageFileInput = document.getElementById('productImageFile');
        const imagePreview = document.getElementById('image-preview');
        const addProductBtn = document.getElementById('addProductBtn');
        const closeBtn = document.querySelector('#productModal .close-button');
        const cancelBtn = document.querySelector('#productModal .cancel-btn');
        const variationsList = document.getElementById('variations-list');
        const addVariationBtn = document.getElementById('addVariationBtn');
        const loadingOverlay = document.getElementById('loading-overlay');

        let products = []; // Veritabanından çekilen ürünleri tutacak dizi

        // Yükleme ekranını gösterir
        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        // Yükleme ekranını gizler
        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }
        
        // Firebase'i başlatın ve kimlik doğrulamasını yapın
        async function initializeFirebase() {
            try {
                showLoading();
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Kimlik doğrulama dinleyicisi
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Auth ile giriş yapıldı. User ID:", userId);
                        // Kullanıcı kimlik doğrulandıktan sonra veritabanı dinleyicisini başlatın
                        setupDatabaseListener();
                    } else {
                        console.log("Kimlik doğrulama durumu değişti. Tekrar giriş yapılıyor...");
                        // Giriş yapılmadıysa anonim olarak giriş yapmayı deneyin
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase Auth ile giriş yapılamadı:", error);
                        }
                    }
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase başlatılırken bir hata oluştu:", error);
                hideLoading();
            }
        }
        
        // Veritabanı dinleyicisini kurar
        function setupDatabaseListener() {
            if (!db || !userId) {
                console.error("Veritabanı veya kullanıcı kimliği hazır değil.");
                hideLoading();
                return;
            }
            
            const productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/products`);
            onSnapshot(productsCollectionRef, (snapshot) => {
                showLoading();
                const updatedProducts = [];
                snapshot.forEach(doc => {
                    updatedProducts.push({ id: doc.id, ...doc.data() });
                });
                products = updatedProducts;
                renderProducts();
                hideLoading();
            }, (error) => {
                console.error("Veritabanı dinleyicisinde hata:", error);
                hideLoading();
            });
        }
        
        // Ürün listesini tabloya çizer
        function renderProducts() {
            productListBody.innerHTML = '';
            products.forEach(product => {
                const row = document.createElement('tr');
                let variationsHTML = '';
                if (product.variations && product.variations.length > 0) {
                    variationsHTML = product.variations.map(v => `
                        <li>
                            ${v.size}: <input type="number" value="${v.price.toFixed(2)}" step="0.01" data-product-id="${product.id}" data-variation-size="${v.size}" class="price-input"> TL
                        </li>
                    `).join('');
                }

                row.innerHTML = `
                    <td><img src="${product.imageUrl || 'https://placehold.co/50x50'}" alt="${product.name} resmi" onerror="this.onerror=null;this.src='https://placehold.co/50x50/DDDDDD/666666?text=Resim+Bulunamadı';"></td>
                    <td>${product.name}</td>
                    <td>${product.category}</td>
                    <td><ul class="product-variations">${variationsHTML}</ul></td>
                    <td class="actions">
                        <button class="edit" data-id="${product.id}"><i class="fas fa-edit"></i> Düzenle</button>
                        <button class="delete" data-id="${product.id}"><i class="fas fa-trash-alt"></i> Sil</button>
                    </td>
                `;
                productListBody.appendChild(row);
            });
        }

        // Fiyat değişikliğini kaydeder
        async function handlePriceChange(event) {
            const productId = event.target.dataset.productId;
            const variationSize = event.target.dataset.variation-size;
            const newPrice = parseFloat(event.target.value);
            if (!isNaN(newPrice)) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    const variation = product.variations.find(v => v.size === variationSize);
                    if (variation) {
                        variation.price = newPrice;
                        try {
                            const productRef = doc(db, `artifacts/${appId}/users/${userId}/products`, productId);
                            await setDoc(productRef, product);
                            console.log(`Ürün ID ${productId}, ölçü ${variationSize} fiyatı veritabanında güncellendi: ${newPrice}`);
                        } catch (error) {
                            console.error("Fiyat güncellenirken hata oluştu:", error);
                        }
                    }
                }
            }
        }
        
        // Modal'ı açar ve formu doldurur (düzenleme için)
        function openModal(product = null) {
            variationsList.innerHTML = ''; // Önceki varyasyonları temizle
            productImageFileInput.value = ''; // Dosya girişini temizle
            imagePreview.style.display = 'none';

            if (product) {
                modalTitle.textContent = "Ürün Düzenle";
                productIdInput.value = product.id;
                productNameInput.value = product.name;
                productCategoryInput.value = product.category;
                
                // Eğer ürünün resim verisi varsa önizlemeyi göster
                if (product.imageUrl) {
                    imagePreview.src = product.imageUrl;
                    imagePreview.style.display = 'block';
                }

                if (product.variations && product.variations.length > 0) {
                    product.variations.forEach(v => addVariationField(v.size, v.price));
                } else {
                    addVariationField();
                }
            } else {
                modalTitle.textContent = "Yeni Ürün Ekle";
                productForm.reset();
                productIdInput.value = '';
                addVariationField(); // Yeni ürün için varsayılan bir alan ekle
            }
            productModal.style.display = 'flex';
        }

        // Modal'ı kapatır
        function closeModal() {
            productModal.style.display = 'none';
        }

        // Dinamik ölçü/fiyat alanları ekler
        function addVariationField(size = '', price = '') {
            const li = document.createElement('li');
            li.classList.add('variation-item');
            li.innerHTML = `
                <input type="text" placeholder="Ölçü (örn: 20 mm)" value="${size}">
                <input type="number" step="0.01" placeholder="Fiyat (TL)" value="${price}">
                <button type="button" class="remove-variation-btn">&times;</button>
            `;
            variationsList.appendChild(li);
        }

        // Dosya seçildiğinde önizleme oluşturur
        productImageFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.style.display = 'none';
            }
        });

        // Form gönderildiğinde çalışacak fonksiyon
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            showLoading();

            const id = productIdInput.value;
            const name = productNameInput.value;
            const category = productCategoryInput.value;
            const imageUrl = imagePreview.src !== '#' ? imagePreview.src : '';

            const variations = [];
            document.querySelectorAll('#variations-list .variation-item').forEach(item => {
                const sizeInput = item.querySelector('input[type="text"]');
                const priceInput = item.querySelector('input[type="number"]');
                if (sizeInput.value && priceInput.value && !isNaN(parseFloat(priceInput.value))) {
                    variations.push({ size: sizeInput.value, price: parseFloat(priceInput.value) });
                }
            });

            if (variations.length === 0) {
                // Burada `alert` yerine özel bir modal kullanılmalıdır
                alert("Lütfen en az bir ölçü ve fiyat girin.");
                hideLoading();
                return;
            }

            const productData = { name, category, imageUrl, variations };

            try {
                if (id) {
                    // Ürünü düzenle
                    const productRef = doc(db, `artifacts/${appId}/users/${userId}/products`, id);
                    await setDoc(productRef, productData);
                    console.log(`Ürün ID ${id} veritabanında güncellendi.`);
                } else {
                    // Yeni ürün ekle
                    const newDocRef = doc(collection(db, `artifacts/${appId}/users/${userId}/products`));
                    await setDoc(newDocRef, productData);
                    console.log(`Yeni ürün veritabanına eklendi.`);
                }
                closeModal();
            } catch (error) {
                console.error("Veri kaydedilirken hata oluştu:", error);
            } finally {
                hideLoading();
            }
        });

        // Event dinleyicileri
        productListBody.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const id = target.dataset.id;
            
            if (target.classList.contains('edit')) {
                const productToEdit = products.find(p => p.id === id);
                if (productToEdit) {
                    openModal(productToEdit);
                }
            } else if (target.classList.contains('delete')) {
                // Burada `confirm` yerine özel bir modal kullanılmalıdır
                if (window.confirm("Bu ürünü silmek istediğinize emin misiniz?")) {
                    try {
                        showLoading();
                        const productRef = doc(db, `artifacts/${appId}/users/${userId}/products`, id);
                        await deleteDoc(productRef);
                        console.log(`Ürün ID ${id} veritabanından silindi.`);
                    } catch (error) {
                        console.error("Ürün silinirken hata oluştu:", error);
                    } finally {
                        hideLoading();
                    }
                }
            }
        });

        productListBody.addEventListener('change', (e) => {
            if (e.target.classList.contains('price-input')) {
                handlePriceChange(e);
            }
        });

        addVariationBtn.addEventListener('click', () => addVariationField());

        variationsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-variation-btn')) {
                e.target.closest('li').remove();
            }
        });

        addProductBtn.addEventListener('click', () => openModal());
        closeBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);
        window.addEventListener('click', (e) => {
            if (e.target === productModal) {
                closeModal();
            }
        });

        // Sayfa yüklendiğinde Firebase'i başlat
        window.onload = initializeFirebase;

    </script>
</body>
</html>
